

<div class="container mx-auto px-4 py-8 flex flex-col gap-8">
  <!-- Section Utilisateurs -->
   <!-- METTRE LES UTILISATEURS SUR UNE PAGE DEDIEE AVEC LE MEME AFFICHAGE QUE SUR LES AUTRES PAGES SAUF QUE LES UTILISATEURS SERONT ACTIFS OU NON -->
  <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Utilisateurs</h2>
    <div class="overflow-x-auto">
      <table mat-table [dataSource]="dataSource" class="min-w-full divide-y divide-gray-200">
        <!-- Pseudo -->
        <ng-container matColumnDef="username">
          <th mat-header-cell *matHeaderCellDef>Pseudo</th>
          <td mat-cell *matCellDef="let user">{{ user.username }}</td>
        </ng-container>

        <!-- Email -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef>Email</th>
          <td mat-cell *matCellDef="let user">{{ user.email }}</td>
        </ng-container>

        <!-- Rôle -->
        <ng-container matColumnDef="role">
          <th mat-header-cell *matHeaderCellDef>Rôle</th>
          <td mat-cell *matCellDef="let user">
            <div class="relative">
              <!-- Badge cliquable pour changer le rôle -->
              <button 
                mat-button
                class="!p-0 !min-w-0 !m-0 !bg-transparent !shadow-none hover:!shadow-md transition-shadow"
                [matMenuTriggerFor]="roleMenu"
                *ngIf="canChangeRole(user.role); else readOnlyRole"
              >
                <span 
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800 hover:bg-blue-200': user.role === 'INVITED',
                    'bg-green-100 text-green-800 hover:bg-green-200': user.role === 'FRIEND',
                    'bg-purple-100 text-purple-800 hover:bg-purple-200': user.role === 'ADMIN',
                    'bg-red-100 text-red-800 hover:bg-red-200': user.role === 'SUPERADMIN'
                  }"
                >
                  {{ user.role }}
                  <mat-icon class="ml-1 !text-xs !w-4 !h-4">expand_more</mat-icon>
                </span>
              </button>
              
              <!-- Badge en lecture seule -->
              <ng-template #readOnlyRole>
                <span 
                  class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium"
                  [ngClass]="{
                    'bg-blue-100 text-blue-800': user.role === 'INVITED',
                    'bg-green-100 text-green-800': user.role === 'FRIEND',
                    'bg-purple-100 text-purple-800': user.role === 'ADMIN',
                    'bg-red-100 text-red-800': user.role === 'SUPERADMIN'
                  }"
                >
                  {{ user.role }}
                </span>
              </ng-template>

              <!-- Menu des rôles disponibles -->
              <mat-menu #roleMenu="matMenu">
                <button 
                  mat-menu-item 
                  *ngFor="let role of availableRoles"
                  (click)="onRoleChange(user, role)"
                  [disabled]="role === user.role"
                >
                  <span 
                    class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium mr-2"
                    [ngClass]="{
                      'bg-blue-100 text-blue-800': role === 'INVITED',
                      'bg-green-100 text-green-800': role === 'FRIEND',
                      'bg-purple-100 text-purple-800': role === 'ADMIN'
                    }"
                  >
                    {{ role }}
                  </span>
                  <mat-icon *ngIf="role === user.role" class="ml-auto">check</mat-icon>
                </button>
              </mat-menu>
            </div>
          </td>
        </ng-container>

        <!-- Actions Utilisateurs -->
        <ng-container matColumnDef="actions">
          <th mat-header-cell *matHeaderCellDef>Actions</th>
          <td mat-cell *matCellDef="let user">
            <button mat-icon-button (click)="onEditUser(user)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button color="warn" (click)="onDeleteUser(user)">
              <mat-icon>delete</mat-icon>
            </button>
          </td>
        </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns" class="bg-gray-100"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-blue-50 transition-colors"></tr>
      </table>
    </div>
  </div>

  <!-- Section Pays -->
  <div class="bg-white rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">Gestion des pays</h2>

    <!-- Formulaire d'ajout -->
    <div class="flex items-center gap-4 mb-6">
      <div class="relative max-w-xs w-full">
        <input
          type="text"
          [(ngModel)]="query"
          (ngModelChange)="onChange($event)"
          placeholder="Entrez le nom du pays..."
          class="w-full px-4 py-3 text-gray-700 bg-white border border-gray-300 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 hover:border-gray-400 transition-all duration-200 placeholder-gray-400"
        />
  <ul *ngIf="suggestions.length" class="absolute left-0 right-0 bg-white border border-gray-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-auto z-50">
          <li *ngFor="let c of suggestions" (click)="selectCountry(c)" class="flex items-center px-4 py-3 cursor-pointer hover:bg-blue-50 transition-colors duration-150 border-b border-gray-100 last:border-b-0">
            <img [src]="c.flags.png" width="24" height="16" alt="" class="mr-3 rounded shadow-sm" />
            <span class="text-gray-700 font-medium">{{ c.translations?.['fra']?.common || c.name.common }}</span>
          </li>
        </ul>
      </div>
      <button
        mat-raised-button
        color="primary"
        [disabled]="!selectedCountry"
        (click)="addCountry()"
        class="px-6 py-3 rounded-lg shadow bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-all"
      >
        Valider
      </button>
    </div>

  
    <!-- Pays actifs -->
    <div class="mt-6">
      <app-item-table
        title="Pays actifs"
        [dataSource]="countries"
        [columns]="['flag', 'name']"
        [actionsTemplate]="activeCountryActions"
      ></app-item-table>
    </div>

    <ng-template #activeCountryActions let-country>
      <button
        mat-icon-button
        [routerLink]="['/admin','countries',country.id,'voyages']"
        matTooltip="Voir les voyages"
      >
        <mat-icon>navigate_next</mat-icon>
      </button>
      <!-- Publier si en draft -->
      <button
        mat-button
        color="accent"
        *ngIf="country.publishedDate == null"
        (click)="publishCountry(country)"
      >
        Publier
      </button>
      <!-- Dépublier si publié -->
      <button
        mat-button
        color="accent"
        *ngIf="country.publishedDate != null"
        (click)="unpublishCountry(country)"
      >
        Dépublier
      </button>
      <!-- Supprimer -->
      <button mat-icon-button color="warn" (click)="deleteCountry(country)">
        <mat-icon>delete</mat-icon>
      </button>
    </ng-template>

    <!-- Pays non publiés -->
    <div class="mt-6">
      <app-item-table
        title="Pays non publiés"
        [dataSource]="unpublishedCountries"
        [columns]="['flag', 'name']"
        [actionsTemplate]="unpublishedCountryActions"
      ></app-item-table>
    </div>

    <ng-template #unpublishedCountryActions let-country>
      <button
        mat-icon-button
        [routerLink]="['/admin','countries',country.id,'voyages']"
        matTooltip="Voir les voyages"
      >
        <mat-icon>navigate_next</mat-icon>
      </button>
      <button
        mat-button
        color="accent"
        (click)="publishCountry(country)"
      >
        Publier
      </button>
      <button mat-icon-button color="warn" (click)="deleteCountry(country)">
        <mat-icon>delete</mat-icon>
      </button>
    </ng-template>

    <!-- Pays supprimés -->
    <div class="mt-6">
      <app-item-table
        title="Pays supprimés"
        [dataSource]="deletedCountries"
        [columns]="['flag', 'name']"
        [actionsTemplate]="deletedCountryActions"
      ></app-item-table>
    </div>

    <ng-template #deletedCountryActions let-country>
      <button mat-button color="primary" (click)="restoreCountry(country)">
        Restaurer
      </button>
    </ng-template>

    <!-- Modal d’erreur pays existant -->
<ng-template #existsDialog let-data>
  <div class="p-6 rounded-xl bg-white shadow-2xl border border-red-200 min-w-[320px] max-w-[90vw] text-center">
    <div class="flex flex-col items-center gap-2">
      <mat-icon class="text-red-500 text-4xl !mb-2">error_outline</mat-icon>
      <h2 mat-dialog-title class="text-xl font-bold text-red-600 mb-2">Erreur</h2>
      <mat-dialog-content class="text-gray-700 text-base mb-4">
        {{ data }}
      </mat-dialog-content>
      <mat-dialog-actions align="center">
        <button mat-raised-button color="primary" mat-dialog-close class="px-6 py-2 rounded-lg shadow bg-gradient-to-r from-red-400 to-pink-500 text-white font-semibold hover:from-red-500 hover:to-pink-600 transition-all">OK</button>
      </mat-dialog-actions>
    </div>
  </div>
</ng-template>
  </div>
</div>