<app-breadcrumb></app-breadcrumb>

<div class="max-w-6xl mx-auto p-5 flex flex-col gap-8">
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <div class="flex items-center gap-4">
      <svg class="w-10 h-10 text-pink-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L15 14l5-5m0 0l-5-5-5 5-2.586-2.586a2 2 0 00-2.828 0L4 16m0 0V8m0 8h8m4 0h8"></path>
      </svg>
      <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Gestion des photos</h1>
    </div>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Ajouter des photos</h2>
    <form [formGroup]="multiplePhotoForm" (ngSubmit)="uploadMultiplePhotos()" class="p-4 flex flex-col gap-5" (keydown.enter)="$event.preventDefault()">
      <div class="flex flex-col gap-4">
        <div class="flex items-center gap-4">
          <input type="file" #multipleFileInput (change)="onMultipleFilesSelected($event)" accept="image/*" multiple style="display: none;" />
          <button mat-raised-button type="button" (click)="multipleFileInput.click()" class="px-6 py-3 rounded-lg shadow-md bg-blue-500 text-white font-semibold hover:bg-blue-600 transition-colors">
            {{ selectedFiles.length > 0 ? 'Ajouter d\'autres photos' : 'Choisir des photos' }}
          </button>
          <span *ngIf="selectedFiles.length > 0" class="text-gray-600 dark:text-gray-400 italic text-sm">{{ selectedFiles.length }} fichier(s) sélectionné(s)</span>
        </div>

        <div *ngIf="selectedFiles.length > 0" class="mt-4 border border-gray-300 dark:border-gray-600 rounded-lg p-4 bg-gray-50 dark:bg-gray-700">
          <div class="flex items-center justify-between mb-4">
            <h4 class="text-gray-800 dark:text-gray-200 text-lg font-medium">Photos sélectionnées :</h4>
            <button mat-button type="button" color="warn" (click)="clearAllSelectedFiles()" class="text-sm text-red-600 dark:text-red-400">
              <mat-icon class="mr-1">clear_all</mat-icon> Vider tout
            </button>
          </div>
          <div *ngFor="let file of selectedFiles; let i = index" class="flex flex-col gap-4 mb-3 p-4 bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-600">
            <div class="flex flex-col md:flex-row items-center md:items-start gap-4">
              <div class="w-24 h-24 flex-shrink-0 relative group">
                <img [src]="getImagePreview(file)" [alt]="file.name" class="w-full h-full object-cover rounded-md border border-gray-200 dark:border-gray-600" />
                <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 opacity-0 group-hover:opacity-100 transition-opacity duration-300 rounded-md">
                  <mat-icon class="text-white text-3xl">zoom_in</mat-icon>
                </div>
              </div>
              
              <div class="flex-1 flex flex-col justify-center">
                <div class="flex justify-between items-center mb-2">
                  <h4 class="text-base font-medium text-gray-900 dark:text-white truncate">
                    <span class="font-bold text-blue-600 dark:text-blue-400">{{ i + 1 }}.</span> {{ file.name }}
                  </h4>
                  <button mat-icon-button type="button" (click)="removeSelectedFile(i)" class="flex-shrink-0 text-gray-400 hover:text-red-500 transition-colors" matTooltip="Supprimer ce fichier">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>
                
                <span class="text-xs text-gray-500 dark:text-gray-400 block">{{ (file.size / 1024 / 1024).toFixed(2) }} MB</span>
                
                <div class="flex flex-wrap gap-2 mt-2">
                  <button 
                    mat-button 
                    type="button"
                    [class.bg-green-100]="fileIsPublished[i]" 
                    [class.text-green-800]="fileIsPublished[i]" 
                    [class.bg-gray-100]="!fileIsPublished[i]" 
                    [class.text-gray-800]="!fileIsPublished[i]" 
                    (click)="toggleFilePublished(i)"
                    class="px-3 py-1 text-xs rounded-full font-semibold transition-colors"
                  >
                    <mat-icon class="text-sm mr-1">{{ fileIsPublished[i] ? 'publish' : 'unpublished' }}</mat-icon> {{ fileIsPublished[i] ? 'Publiée' : 'Brouillon' }}
                  </button>
                  
                  <button 
                    mat-button 
                    type="button"
                    [class.bg-blue-100]="fileIsPublic[i]" 
                    [class.text-blue-800]="fileIsPublic[i]" 
                    [class.bg-gray-100]="!fileIsPublic[i]" 
                    [class.text-gray-800]="!fileIsPublic[i]" 
                    (click)="toggleFilePublic(i)"
                    [disabled]="!fileIsPublished[i]"
                    [matTooltip]="getPublicButtonTooltip(i)"
                    class="px-3 py-1 text-xs rounded-full font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <mat-icon class="text-sm mr-1">{{ fileIsPublic[i] ? 'visibility' : 'visibility_off' }}</mat-icon> {{ fileIsPublic[i] ? 'Publique' : 'Privée' }}
                    <mat-icon *ngIf="isPublicToggleDisabled(i)" class="ml-1 text-sm text-yellow-600">lock</mat-icon>
                  </button>
                  
<button 
  mat-button 
  type="button"
  [class.bg-yellow-100]="fileIsFavorite[i]" 
  [class.text-yellow-800]="fileIsFavorite[i]" 
  [class.bg-gray-100]="!fileIsFavorite[i]" 
  [class.text-gray-800]="!fileIsFavorite[i]" 
  (click)="toggleFileFavorite(i)"
  [disabled]="isFavoriteToggleDisabled(i)"
  [matTooltip]="getFavoriteButtonTooltip(i)"
  class="px-3 py-1 text-xs rounded-full font-semibold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
>
  <mat-icon class="text-sm mr-1">{{ fileIsFavorite[i] ? 'star' : 'star_border' }}</mat-icon> 
  {{ fileIsFavorite[i] ? 'Favori' : 'Normal' }}
  <mat-icon *ngIf="isFavoriteToggleDisabled(i)" class="ml-1 text-sm text-red-600">block</mat-icon>
</button>
                </div>
              </div>
            </div>
            
            <div class="flex flex-col gap-4 mt-2 border-t pt-4 border-gray-200 dark:border-gray-600">
            
              
              <mat-form-field appearance="outline" class="w-full"> 
                <textarea matInput [(ngModel)]="fileDescriptions[i]" [ngModelOptions]="{standalone: true}" placeholder="Description optionnelle" rows="2" class="bg-transparent text-gray-900 dark:text-white border-none rounded-md px-3 py-2"></textarea>
              </mat-form-field>
            </div>
          </div>
          <div class="flex justify-end mt-6">
            <button mat-raised-button color="accent" type="submit" [disabled]="selectedFiles.length === 0" class="px-6 py-3 rounded-lg shadow bg-gradient-to-r from-purple-500 to-pink-600 text-white font-semibold hover:from-purple-600 hover:to-pink-700 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
              Uploader {{ selectedFiles.length }} photo(s)
            </button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Photos publiées</h3>
    <app-item-table
      [dataSource]="photos"
      [columns]="photoColumns"
      [actionsTemplate]="publishedPhotoActions"
    ></app-item-table>

<ng-template #publishedPhotoActions let-photo>
  <div class="flex items-center gap-2">
    <button 
      mat-icon-button 
      (click)="toggleFavorite(photo)" 
      [color]="photo.favorite ? 'accent' : 'basic'" 
      [disabled]="!canToggleFavorite(photo)"
      [matTooltip]="getFavoriteTooltip(photo)" 
      class="text-yellow-500 hover:text-yellow-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
      <mat-icon>{{ photo.favorite ? 'star' : 'star_border' }}</mat-icon>
    </button>
    <button 
      mat-icon-button 
      (click)="togglePublic(photo)" 
      [color]="photo.isPublic ? 'primary' : 'basic'" 
      [disabled]="!canTogglePublic(photo)"
      [matTooltip]="getPublicTooltip(photo)" 
      class="text-blue-500 hover:text-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
      <mat-icon>{{ photo.isPublic ? 'visibility' : 'visibility_off' }}</mat-icon>
    </button>
    <button mat-button color="accent" (click)="unpublish(photo)" class="text-sm text-orange-500 hover:text-orange-700 transition-colors">
      Dépublier
    </button>
    <button mat-icon-button color="warn" (click)="delete(photo)" class="text-red-500 hover:text-red-700 transition-colors">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</ng-template>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Photos non publiées</h3>
    <app-item-table
      [dataSource]="unpublishedPhotos"
      [columns]="unpublishedPhotoColumns"
      [actionsTemplate]="unpublishedPhotoActions"
    ></app-item-table>

<ng-template #unpublishedPhotoActions let-photo>
  <div class="flex items-center gap-2">
    <button 
      mat-icon-button 
      (click)="toggleFavorite(photo)" 
      [color]="photo.favorite ? 'accent' : 'basic'" 
      [disabled]="!canToggleFavorite(photo)"
      [matTooltip]="getFavoriteTooltip(photo)" 
      class="text-yellow-500 hover:text-yellow-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
      <mat-icon>{{ photo.favorite ? 'star' : 'star_border' }}</mat-icon>
    </button>
    <button 
      mat-icon-button 
      (click)="togglePublic(photo)" 
      [color]="photo.isPublic ? 'primary' : 'basic'" 
      [disabled]="!canTogglePublic(photo)"
      [matTooltip]="getPublicTooltip(photo)" 
      class="text-blue-500 hover:text-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
      <mat-icon>{{ photo.isPublic ? 'visibility' : 'visibility_off' }}</mat-icon>
    </button>
    <button mat-button color="primary" (click)="publish(photo)" class="text-sm text-green-500 hover:text-green-700 transition-colors">
      Publier
    </button>
    <button mat-icon-button color="warn" (click)="delete(photo)" class="text-red-500 hover:text-red-700 transition-colors">
      <mat-icon>delete</mat-icon>
    </button>
  </div>
</ng-template>
  </div>

  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6">
    <h3 class="text-2xl font-bold text-gray-900 dark:text-white mb-4 border-b pb-2 border-gray-200 dark:border-gray-700">Photos supprimées</h3>
    <app-item-table
      [dataSource]="deletedPhotos"
      [columns]="deletedPhotoColumns"
      [actionsTemplate]="deletedPhotoActions"
    ></app-item-table>

    <ng-template #deletedPhotoActions let-photo>
      <div class="flex items-center gap-2">
        <button mat-button color="primary" (click)="restore(photo)" class="text-sm text-blue-500 hover:text-blue-700 transition-colors">
          Restaurer
        </button>
      </div>
    </ng-template>
  </div>
</div>